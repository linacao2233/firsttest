{% extends 'base.html' %}
{% load static %}
<style type="text/css">
{% block style%}

{% endblock %}
</style>


{% block content %}

{% include 'navbar.html' %}
<h1>Test page</h1>

<div class="container">
<section class="row">


<div id="map-canvas" class="col-md-6" style="height: 60vh;"></div>


<div class="col-md-6" style="overflow: auto; height: 60vh;">

    {% for apart in apartlist %}
    <div class="mx-2 my-2 listapart">
    <img src="{{apart.iconpic.url}}">
    <a href="{% url 'detail' apart.slug %}"><h2>{{ apart.title }}</h2></a>
    </div>

    {% endfor %}
</div>

</section>

</div>


<script src="https://maps.googleapis.com/maps/api/js?v=3&key={{googleapikey}}"></script>
<script src="{% static 'js/fontawesome-markers.min.js' %}"></script>


{% endblock %}

<script type="text/javascript">
	{% block script %}


var apartmarkers = [];
var map = new google.maps.Map(document.getElementById('map-canvas'));


function initialize() {
    var bounds = new google.maps.LatLngBounds();
    var infowindow1 = new google.maps.InfoWindow();

    function addMarker(lat, lng, title, label, content) {
        var position = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
            position: position,
            map: map,
            title: title,
            label: label,
        });
        var infowindow = new google.maps.InfoWindow({
        	content: content,
        	maxwidth: 20,
        })
        marker.addListener('click', function(){
        	//infowindow.open(map,marker)
        	infowindow1.setContent(content);
        	//infowindow1.setPosition(position);
        	infowindow1.open(map,this);
        })
        bounds.extend(position);
        apartmarkers.push(marker);
        //marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
    }

    function addGateMarker(lat,lng,title) {
        var position = new google.maps.LatLng(lat, lng);
        var marker = new google.maps.Marker({
            position: position,
            map: map,
            title: title,
            //labelContent: '<i class="fa fa-camera-retro"></i>',
        });
        //marker.setIcon('http://maps.google.com/mapfiles/kml/pal2/icon5.png')
        marker.setIcon('http://labs.google.com/ridefinder/images/mm_20_green.png'
            )
    }

    var apartcontent;
    {% for poi in apartlist %}
      apartcontent = '<a href="{{poi.officalweblink}}">{{ poi.title }}</a> <br>{{ poi.description}}'

        addMarker({{ poi.location2.y }}, {{ poi.location2.x }}, "{{ poi.title }}", "{{forloop.counter}}", apartcontent);

    {% endfor %}


    {% for gate in gatelist %}
        addGateMarker({{ gate.location.y }}, {{ gate.location.x }}, "{{ gate.title }}");
    {% endfor %}
    map.fitBounds(bounds);

    // function checking

    // for (var i=0; i<apartmarkers.length; i++) {
    //     apartmarkers[i].setIcon('http://maps.google.com/mapfiles/kml/pal2/icon5.png')
}

function loadMapFromcurrentBounds(){
    var label = 0;
    for (var i=0; i< apartmarkers.length; i++){
        if (map.getBounds().contains(apartmarkers[i].getPosition())) {
            //apartmarkers[i].setMap();
            $('.listapart:nth-child('+(i+1)+')').show();
            label += 1;
            apartmarkers[i].setLabel(label.toString());

        }
        else {
            $('.listapart:nth-child('+(i+1)+')').hide();

             //apartmarkers[i].setMap(null);
        }
    }
}

google.maps.event.addDomListener(window, 'load', initialize);
google.maps.event.addListener(map, 'idle', loadMapFromcurrentBounds);





$('.listapart:visible').hover(
    function() {
        var idx = $(this).index();
        //apartmarkers[idx].setIcon('http://maps.google.com/mapfiles/kml/pal2/icon5.png');
        apartmarkers[idx].setAnimation(google.maps.Animation.BOUNCE);

    },
    function() {
        var idx = $(this).index();
        console.log(idx);
        //apartmarkers[idx].setIcon('http://maps.google.com/mapfiles/kml/pal2/icon5.png');
        apartmarkers[idx].setAnimation(null);
    }
    )


	{% endblock %}
</script>

