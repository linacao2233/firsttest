{% extends 'base.html' %}


{% block header %}
<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vue-star-rating/dist/star-rating.min.js"></script>

{% endblock %}


{% block content %}
{% include 'navbar.html' %}
<div class='container'> 
<h1> {{apart.title}}</h1>

<div id="imagesession">
	<div id="picCarousel" class="carousel bg-faded">
		<div class="carousel-inner">
			<div class="carousel-item active">
			<img src="{{apart.iconpic.url}}" class="img-responsive thumbnail">				
			</div>
			{% for image in apart.ApartImage_set %}
			<div class="carousel-item">
			<img src="{{image.url}}" class="img-responsive thumbnail">
			</div>
			{% endfor %}
		</div>
	     <a class="carousel-control-prev" href="#picCarousel" role="button" data-slide="prev">
	      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
	      <span class="sr-only">Previous</span>
	    </a>
	    <a class="carousel-control-next" href="#picCarousel" role="button" data-slide="next">
	      <span class="carousel-control-next-icon" aria-hidden="true"></span>
	      <span class="sr-only">Next</span>
	    </a>
	</div>

	<img src="{{apart.iconpic.url}}" width="100px">
	{% for image in apart.ApartImage_set %}
		<img src="{{image.url}}" width="100px">
	{% endfor %}
</div>

<div class="row">
	<div class="col-md-4" id="map">

		<script src="https://maps.googleapis.com/maps/api/js?v=3&key={{apikey}}&sensor=false"></script>
		<div class="card">
		<img class="card-img-top" src="http://maps.googleapis.com/maps/api/staticmap?center={{ apart.location2.y }},{{ apart.location2.x }}&zoom=14&size=200x200&maptype=roadmap&markers={{ apart.location2.y }},{{ apart.location2.x }}&sensor=false&visual_refresh=true&scale=2" width="100%" alt="{{apart.title}} address on google map">
		<div class="card-block">
			<ul class="fa-ul">
			<li class="my-3"><i class="fa-li fa fa-envelope-open"></i> {{apart.email}} </li>
			<li class="my-3"><i class="fa-li fa fa-mobile"></i> {{apart.phonenumber}} </li>
			<li class="my-3"><i class="fa-li fa fa-map-marker"></i> {{apart.address}} </li>
			
			</ul>
			
		</div>
		</div>
		
	</div>
	<div class="col-md-8">
		<a href="{{ apart.officalweblink }}"><h2>{{ apart.title }}</h2></a>

		<p>{{ apart.description}}</p>
		<p>{{ apart.phonenumber}}</p>
		<p>{{ apart.email}}</p>
		<p>{{ apart.numberofrooms}}</p>
		<p>{{ apart.numberofstudents}}</p>
		<p>{{ apart.roomsperbath}}</p>
		<p>{{ apart.facebooklink}}</p>
	</div>
</div>


<div id='comments_session'>

	<div class="row">
	<div class="form-group col-sm-12">
	<div id="div_id_body" class="control-group"><label for="id_body" class="control-label "> Add Comment: </label> 
	<div class="controls"><textarea v-model="newcomment" name="body" cols="40" rows="2" id="id_body" class="form-control textarea"></textarea></div>
	</div>
	<star-rating v-model="rating"></star-rating>
	</div>
	</div>

	<button class='btn btn-secondary' @click="addNewItem"> ADD </button>

	<comment v-for="item in comments" :onecomment="item"></comment>


	<div id='comments'>
		{% for comment in comments %}
		<div class="card-group row">
		<div class='card col-md-2 mb-2'>
			<div class="text-muted"> {{comment.created_by}} </div>
			<small class='text-muted'>{{comment.modifiedTime|timesince}} ago</small>
			<div class="pull-right">
					{% with ''|center:comment.starlevel as range %}
			{% for _ in range %}
				<i class="fa fa-star"></i>
			{% endfor %}
			{% endwith %}
			</div>
		</div>
		<div class='card col-md-10 mb-2'>
			<p class='card-text'>{{comment.body}},



			</p>

		</div>
		</div>

		{% endfor %}
	</div>

{% verbatim %}

</div>

<template id="commenttemplate">
	<div class="card-group row">
		<div class="card col-md-2 mb-2">
			{{ onecomment.created_by }} <br>
			<small>{{ onecomment.created_on }}</small>
		</div>	
		<div class='card col-md-10 mb-2'>
			<p class='card-text'>{{onecomment.body}}</p>
		</div>	
	</div>
</template>

{% endverbatim %} 


</div>



{% endblock %}


<script type="text/javascript">
	{% block script %}

	Vue.component('star-rating', VueStarRating.default)

	Vue.component('comment', {
		props: ['onecomment'],
		template: '#commenttemplate',
	})

	var commentapp = new Vue ({
		el: '#comments_session',
		data: {
			newcomment: '',
			rating: 0,
			comments: [],
		},
		methods: {
			addNewItem: function() {
				data={
					body: this.newcomment,
					created_by: "{{ request.user.username }}",
					created_on: 'just now',
					rating: this.rating,
				};
				this.comments.unshift(data);

				senddata = {
					body: this.newcomment,
					postid: "{{ apart.slug }}",
					rating: this.rating,
				};

				this.newcomment = '';

				$.ajax({
					url: "{% url 'commentsave' %}",
					data: senddata,
					method: "POST",

					success: function(data){
						console.log('vue success');

					},

					error: function(xhr){
						console.log(xhr);
					},

				});

			},

		},
	});



function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

	{% endblock %}
</script>