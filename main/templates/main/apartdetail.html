{% extends 'base.html' %}
{% load crispy_forms_tags %}



{% block header %}
<script src="https://unpkg.com/vue"></script>
<script src="https://unpkg.com/vue-star-rating/dist/star-rating.min.js"></script>

{% endblock %}

<style type="text/css">
	{% block style %}
	.carousel-inner {
		height:300px;
	}
	.carousel-item > img {
		height: 300px;
		margin: auto;
	}
	.carousel-caption {
		position: absolute;
		top: 0;
		right: 0;
		color: blue;
	}
	p span {
	color: red;
	}

	{% endblock %}
</style>


{% block content %}
{% include 'navbar.html' %}
<div class='container'> 
<h1> {{apart.title}}</h1> 
    {% with ''|center:apart.starlevel as range %}
			{% for _ in range %}
				<i class="fa fa-star" style="color: orange;"></i>
			{% endfor %}
			{% endwith %}

	({{apart.comment_set|length}} comments) <br>
	<ul class="fa-ul">
		<li><i class="fa-li fa fa-envelope-open"></i> {{apart.email}} </li>
		<li><i class="fa-li fa fa-phone"></i> {{apart.phonenumber}} </li>
		<li><i class="fa-li fa fa-map-marker"></i>{{apart.address}} <a href="#map">Map</a></li>
		
	</ul>

<div class="row">
	<div id="imagesession" class="col-md-8 mt-3">
		<div id="picCarousel" class="carousel bg-faded">
			<ol class="carousel-indicators">
			    <li data-target="#picCarousel" data-slide-to="0" class="active"></li>
			    {% for apartimage in apart.apartimage_set.all %}
			    <li data-target="#picCarousel" data-slide-to="{{forloop.counter}}"></li>
			    {% endfor %}
				
			</ol>
			<div class="carousel-inner">
				<div class="carousel-item active">
				<img src="{{apart.iconpic.url}}" class="img-responsive thumbnail">
				<div class="carousel-caption">
				Image 0 of {{apart.apartimage_set.all.count }}
					
				</div>				
				</div>
				{% for apartimage in apart.apartimage_set.all %}
				<div class="carousel-item">
				<img src="{{apartimage.image.url}}" class="img-responsive thumbnail">
				<div class="carousel-caption">
				Image {{ forloop.counter }} of {{apart.apartimage_set.all.count }}
				</div>
				</div>
				{% endfor %}
			</div>
		     <a class="carousel-control-prev" href="#picCarousel" role="button" data-slide="prev">
		      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
		      <span class="sr-only">Previous</span>
		    </a>
		    <a class="carousel-control-next" href="#picCarousel" role="button" data-slide="next">
		      <span class="carousel-control-next-icon" aria-hidden="true"></span>
		      <span class="sr-only">Next</span>
		    </a>
		</div>

		<div class="mt-2 bg-faded">
		<img src="{{apart.iconpic.url}}" class="smallimagicon" width="100px">
		{% for apartimage in apart.apartimage_set.all %}
			<img src="{{apartimage.image.url}}" class="smallimagicon" width="100px">
		{% endfor %}
		</div>
	</div>
	<div class="col-md-4 bg-faded" id="contact">
	{% if message %}
	<p> {{ message }} </p>
	<a class="btn btn-primary" href="{% url 'contact' %}"> send again </a>
	{% else %}

	<form method="POST" action=''> {% csrf_token %}
	{% crispy contactform %}
	</form>
	{% endif %}
		
	</div>


	<div class="col-md-8" id="description">
		<p><span>Web Address: </span> <a href="{{ apart.officalweblink }}">{{ apart.officalweblink }}</a></p>
		<p><span>Facebook Address: </span>  {{ apart.facebooklink}}</p>
		<p><span>Total number of rooms: </span>  {{ apart.numberofrooms}}</p>
		<p><span>Uplimit of hosting: </span>  {{ apart.numberofstudents}} students</p>
		<p><span>Type of rooms: </span>  {{ apart.NumberOfPeoplePerRoom}} people rooms</p>
		<p><span>How many rooms share one bathroom?: </span>  {{ apart.roomsperbath}}</p>

	</div>
<div class="col-md-8">
<h3>Features</h3>
</div>

	<div class="col-md-8" id="features">
		{% for feature in apart.apartfeatures.all %}
		{{ feature.name }}
		{% endfor %}
	</div>

	<div class="col-md-8">
<h3> Address </h3>
</div>
<div class="col-md-8">
	<div id="map" style="height: 300px"></div>
</div>
</div>


<div id='comments_session'>

	<div class="row">
	<div class="form-group col-sm-12">
	<div id="div_id_body" class="control-group"><label for="id_body" class="control-label "> Add Comment: </label> 
	<div class="controls"><textarea v-model="newcomment" name="body" cols="40" rows="2" id="id_body" class="form-control textarea"></textarea></div>
	</div>
	<star-rating v-model="rating"></star-rating>
	</div>
	</div>

	<button class='btn btn-secondary' @click="addNewItem"> ADD </button>

	<comment v-for="item in comments" :onecomment="item"></comment>


	<div id='comments'>
		{% for comment in comments %}
		<div class="card-group row">
		<div class='card col-md-2 mb-2'>
			<div class="text-muted"> {{comment.created_by}} </div>
			<small class='text-muted'>{{comment.modifiedTime|timesince}} ago</small>
			<div class="pull-right">
					{% with ''|center:comment.starlevel as range %}
			{% for _ in range %}
				<i class="fa fa-star"></i>
			{% endfor %}
			{% endwith %}
			</div>
		</div>
		<div class='card col-md-10 mb-2'>
			<p class='card-text'>{{comment.body}},



			</p>

		</div>
		</div>

		{% endfor %}
	</div>

{% verbatim %}

</div>

<template id="commenttemplate">
	<div class="card-group row">
		<div class="card col-md-2 mb-2">
			{{ onecomment.created_by }} <br>
			<small>{{ onecomment.created_on }}</small>
		</div>	
		<div class='card col-md-10 mb-2'>
			<p class='card-text'>{{onecomment.body}}</p>
		</div>	
	</div>
</template>

{% endverbatim %} 

</div>

<script src="https://maps.googleapis.com/maps/api/js?&key={{apikey}}"></script>


{% endblock %}


<script type="text/javascript">
	{% block script %}

	var position = new google.maps.LatLng({{apart.location2.y}}, {{apart.location2.x}});
	var map = new google.maps.Map(document.getElementById('map'), {
        	gestureHandling: 'cooperative',
        	zoom: 15,
        	center: position,
        });
    var marker = new google.maps.Marker({
                position: position,
                map: map,
            });



	$('.smallimagicon').click(function() {
		var idx = $(this).index();
		$('#picCarousel').carousel(idx);

	})

	Vue.component('star-rating', VueStarRating.default)

	Vue.component('comment', {
		props: ['onecomment'],
		template: '#commenttemplate',
	})

	var commentapp = new Vue ({
		el: '#comments_session',
		data: {
			newcomment: '',
			rating: 0,
			comments: [],
		},
		methods: {
			addNewItem: function() {
				data={
					body: this.newcomment,
					created_by: "{{ request.user.username }}",
					created_on: 'just now',
					rating: this.rating,
				};
				this.comments.unshift(data);

				senddata = {
					body: this.newcomment,
					postid: "{{ apart.slug }}",
					rating: this.rating,
				};

				this.newcomment = '';

				$.ajax({
					url: "{% url 'commentsave' %}",
					data: senddata,
					method: "POST",

					success: function(data){
						console.log('vue success');

					},

					error: function(xhr){
						console.log(xhr);
					},

				});

			},

		},
	});



function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

	{% endblock %}
</script>